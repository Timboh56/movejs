var Region=function(t){var t=t||{};this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.fill_color=t.fillColor,this.label=t.label,this.moveFunction=t.moveFunction};Region.prototype.draw=function(t){t.strokeStyle=this.fill_color,t.strokeRect(this.x,this.y,this.width,this.height)},Region.prototype.onMove=function(){null!=this.moveFunction&&this.moveFunction()};var Move=function(t){function i(i,e,s,n,a){this.DEFAULT_DISPLAY_CANVAS="none",this.DEFAULT_INTERVAL_AMOUNT=10,this.DEFAULT_THRESHOLD=51;var h=this,a=a||{};this.thresholdAmount=a.thresholdAmount||this.DEFAULT_THRESHOLD,this.stream=t("#"+i)[0],this.cnvs=t("#"+e)[0],this.cnvs_blended=t("#"+s)[0],this.cnvs_ctxt=this.cnvs.getContext("2d"),this.blended_ctxt=this.cnvs_blended.getContext("2d"),this.stream.style.display=a.display_canvas||this.DEFAULT_DISPLAY_CANVAS,this.cnvs.style.display=a.display_canvas||this.DEFAULT_DISPLAY_CANVAS,this.interval=a.intervalAmount||this.DEFAULT_INTERVAL_AMOUNT,this.regions=n,this.timeout=!1,this.last_image_data,this.cnvs_ctxt.translate(this.cnvs.width,0),this.cnvs_ctxt.scale(-1,1),this.webcamSetup().done(function(){h.update()})}return i.prototype={webcamSetup:function(){var i=this;navigator.usermedia=navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;var e=t.Deferred();return null!==navigator.usermedia?navigator.usermedia({video:!0,audio:!1},function(t){i.stream.src=window.webkitURL.createObjectURL(t),e.resolve()},function(t){console.log("Your browser returned the following error: "+t),e.reject()}):(console.log("Sorry, your browser does not support user media"),e.reject()),e.promise()},update:function(){this.draw(),this.blend(),this.timeOut=setTimeout(this.update.bind(this),10)},draw:function(t){this.cnvs_ctxt.drawImage(this.stream,0,0,this.stream.width,this.stream.height)},difference:function(t,i,e){if(i.length!=e.length)return null;for(var s=0,n=i.length,a=!1;n>s;){var h,o=(this.fastAbs(i[s]-e[s])+this.fastAbs(i[s+1]-e[s+1])+this.fastAbs(i[s+2]-e[s+2]))/3;255==(h=this.threshold(o,this.thresholdAmount))&&(a=!0),t[s]=h,t[s+1]=h,t[s+2]=h,t[s+3]=255,s+=4}},fastAbs:function(t){return(t^t>>31)-(t>>31)},threshold:function(t,i){return t>i?255:0},blend:function(){var t=this.cnvs.width,i=this.cnvs.height,e=this.cnvs_ctxt.getImageData(0,0,t,i);this.last_image_data||(this.last_image_data=this.cnvs_ctxt.getImageData(0,0,t,i));var s=this.cnvs_ctxt.createImageData(t,i);this.difference(s.data,e.data,this.last_image_data.data),this.blended_ctxt.putImageData(s,0,0),this.last_image_data=e,this.checkRegions()},checkRegions:function(){for(var t in this.regions)this.checkRegion(this.regions[t]),this.regions[t].draw(this.blended_ctxt)},checkRegion:function(t){for(var i=0,e=this,s=this.blended_ctxt.getImageData(t.x,t.y,t.width,t.height);i<s.data.length;){var n=s.data[i]+s.data[i+1]+s.data[i+2];0!=n&&0==e.timeout&&(t.onMove(),e.timeout=!0,setTimeout(function(){e.timeout=!1},e.interval)),i+=4}}},i}(jQuery);
